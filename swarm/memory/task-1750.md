# Task 1750 — ZozoBet "חזרה לאדמין" Bug Fix

**Date**: 2026-02-14
**Status**: ✅ Fixed & Tested in Sandbox
**File**: `/root/sandbox/BettingPlatform/backend/src/routes/admin.js`

## Root Cause (3 bugs)

1. **requireRole middleware blocking** — `return-to-admin` route was AFTER `router.use(auth, requireRole('admin','agent'))`. During impersonation the token is a player token → 403 Forbidden.
2. **JWT_SECRET mismatch** — `admin.js` used `process.env.JWT_SECRET` without fallback, but `auth.js` uses fallback `'betting_jwt_secret'`. If env var not set → different secrets → verify fails.
3. **Cookie path missing** — `adminToken` cookie didn't have `path:'/'`, so it might not be sent on `/api/admin/return-to-admin`.

## Fixes Applied

1. Moved `return-to-admin` route BEFORE the `router.use(auth, requireRole(...))` middleware
2. Added `|| 'betting_jwt_secret'` fallback to `jwt.verify()` in return-to-admin
3. Added `path: '/'` to adminToken cookie in impersonate route

## Testing

- Browser test: login → admin → impersonate Avi1 → click "חזרה לאדמין" → ✅ returned to admin panel
- curl test: full cookie jar flow → `{"ok":true}`
- journalctl confirms: adminToken EXISTS, decode successful

## Production

⛔ NOT applied to production yet. Changes only in `/root/sandbox/BettingPlatform/`.
