# Task 2809 — ניקוי אירועים + Settlement אוטומטי

## בעיות
1. **אירועים שנגמרו עדיין מופיעים ב-live** — 1,265 אירועים תקועים (נוקו ידנית)
2. **הימורים פתוחים לא נסגרים** — settlement engine לא רץ אוטומטית
3. **משחקים בלי תוצאות** — events marked completed but no final scores

## מה צריך לתקן

### 1. Aggregator — ניקוי אירועים חכם
ב-`aggregator/src/index.js`:
- כשמשחק לא מופיע יותר ב-BetsAPI inplay → סמן completed
- ⚠️ כבר קיים cleanup ב-90 דקות, אבל צריך גם לבדוק שהתוצאות נשמרו
- אם event completed + יש scores → הפעל settlement

### 2. Settlement Engine אוטומטי
ב-`backend/src/engines/settlement.js`:
- כרגע settlement רץ רק כשקוראים לו ידנית
- צריך: cron/interval שרץ כל 2 דקות ובודק:
  - events שסטטוס שלהם `completed` + יש `scores`
  - bets פתוחים על אותם events
  - settle: h2h (מי ניצח), totals (over/under), spreads
- שמור תוצאות: bet.status = won/lost, bet.settledAt = now
- עדכן balance של user (won → +potentialWin)

### 3. API Filter — לא להציג אירועים שנגמרו
ב-`backend/src/routes/events.js`:
- הוסף: `status: {$ne: "completed"}` ל-query
- או: אל תציג events שהתחילו לפני 3 שעות ואין להם סטטוס live

### 4. Void אוטומטי
- הימורים על events שלא נמצאו (eventId לא קיים ב-DB) → void + refund
- הימורים על events completed בלי scores אחרי 24 שעות → void + refund

## מידע טכני
⛔ קרא swarm/skills/zozobet-schema.md לפני שמתחיל!

- Settlement engine: `/root/BettingPlatform/backend/src/engines/settlement.js`
- Aggregator: `/root/BettingPlatform/aggregator/src/index.js`
- Events routes: `/root/BettingPlatform/backend/src/routes/events.js`
- Bets model: field `user` (NOT userId), `stake` (NOT amount), `totalOdds` (NOT odds)
- Bets selections: `b.selections[0].outcome` = the pick

### Settlement Logic for h2h:
```javascript
// outcome format: "TeamName_h2h" or "Draw_h2h"
const pick = sel.outcome.replace('_h2h','');
const homeWin = scores.home > scores.away;
const awayWin = scores.away > scores.home;
const draw = scores.home === scores.away;

if (pick === homeName && homeWin) → WON
if (pick === awayName && awayWin) → WON  
if (pick === 'Draw' && draw) → WON
else → LOST
```

## Sandbox
⛔ עבוד ב-sandbox: /root/sandbox/BettingPlatform
URL: http://95.111.247.22:9089
DB: betting_sandbox

## Browser Tests
- count: div → min: 100 → "אירועים מופיעים בדף"
- noErrors → "אין שגיאות JS קריטיות"
