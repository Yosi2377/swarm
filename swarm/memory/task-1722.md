# Task 1722 — Settlement Engine Fix

**Date**: 2026-02-14
**Status**: ✅ Complete

## Changes Made

### 1. settlement.js — Full Rewrite
**File**: `/root/sandbox/BettingPlatform/backend/src/engines/settlement.js`

- **h2h outcome matching**: Strip `_h2h` suffix before comparing team names
- **Draw matching**: Handle both `Draw_h2h` and `Draw`
- **totals support**: `O_*` = Over, `U_*` = Under, compare total vs point line
- **spreads support**: Apply point spread to home/away score
- **void handling**: Push outcomes (exact tie on line) → void, recalculate odds
- **Extracted `resolveSelection()`** for testability

### 2. resettle.js — New Script
**File**: `/root/sandbox/BettingPlatform/backend/src/scripts/resettle.js`

- Finds open bets with pending selections for completed events
- Supports `--dry-run` and `--event-id <id>` flags
- Runs `settleEvent()` for each

## Resettlement Results
| Event | Score | Market | Outcome | Result |
|-------|-------|--------|---------|--------|
| Žalgiris vs Hapoel Tel Aviv | 93-82 | totals | Over (line 168.5, total 175) | ✅ Won |
| Antalyaspor vs Samsunspor | 3-1 | totals | Over (line 3.5, total 4) | ✅ Won |
| Galatasaray vs Eyüpspor | 5-1 | totals | Under (line 5.5, total 6) | ❌ Lost |

Open bets after resettlement: **0**
