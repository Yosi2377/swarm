# Task 3972: שדרוג מערכת זמני משחקים

## Status: ready-for-deploy

## Changes Made

### 1. Aggregator (`aggregator/src/inplay-parser.js`)
- Added raw timer fields: `rawTM`, `rawTU`, `rawTT`, `rawTS` from bet365 inplay data
- `rawTM` = match minute, `rawTU` = timestamp of snapshot, `rawTT` = timer type (1=running, 0=stopped), `rawTS` = seconds

### 2. Aggregator (`aggregator/src/index.js`)
- Changed live scores polling from **30s → 60s** (saves ~60 API calls/hour)
- Added in-memory `timerState` map for clock stoppage detection
- Stores `timerTM`, `timerTU`, `timerTS`, `timerStopped`, `timerUpdatedAt` in DB
- Clock stoppage detection: TT=0, HT/break/FT period, or same TM+TU across polls

### 3. Backend (`backend/src/routes/events.js`)
- Added `timerTM`, `timerTU`, `timerTS`, `timerStopped`, `timerUpdatedAt` to event detail responses

### 4. Frontend (`backend/public/index.html`)
- New `parseTU()` function to parse BetsAPI timestamp
- `getClock()` rewritten: uses TM + local elapsed from TU for smooth minute counting
- When `timerStopped=true`: freezes at TM and shows ⏸ indicator
- Fallback to old logic when timer fields not available

## Credit Budget Impact
- Before: ~120 inplay calls/hour (every 30s)
- After: ~60 inplay calls/hour (every 60s)
- Savings: ~60 credits/hour for odds and other calls

## Tests
- curl -so /dev/null -w "%{http_code}" http://95.111.247.22:9089 → expect 200
- systemctl is-active sandbox-betting-backend → expect active
- curl -s http://95.111.247.22:9089/api/events?live=true | python3 -c "import sys,json;d=json.load(sys.stdin);assert isinstance(d,list)"

## Browser Tests
- exists: .mn → "match minute display exists"
- exists: .mr.live-row → "live match rows exist"
